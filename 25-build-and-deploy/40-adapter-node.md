# Серверы Node
---

Чтобы создать автономный сервер Node, используйте [`adapter-node`](https://github.com/sveltejs/kit/tree/master/packages/adapter-node).

## Использование

Установите с помощью `npm i -D @sveltejs/adapter-node`, затем добавьте адаптер в ваш `svelte.config.js`:

**```svelte.config.js```**
```js
import adapter from '@sveltejs/adapter-node';

export default {
	kit: {
		adapter: adapter()
	}
};
```

## Развёртывание

Сначала создайте свое приложение с помощью `npm run build`. Это создаст рабочий сервер в выходном каталоге, указанном в опциях адаптера, по умолчанию это `build`.

Для запуска приложения вам понадобится выходной каталог, файл проекта `package.json` и рабочие зависимости в `node_modules`. Рабочие зависимости могут быть сгенерированы с помощью команды `npm ci --prod` (вы можете пропустить этот шаг, если ваше приложение не имеет никаких зависимостей). Затем вы можете запустить ваше приложение с помощью этой команды:

```bash
node build
```

Зависимости для разработки будут включены в ваше приложение с помощью [Rollup](https://rollupjs.org). Чтобы контролировать, будет ли данный пакет собран в бандл или вынесен отдельно, поместите его в секцию `devDependencies` или `dependencies` соответственно в вашем файле `package.json`.

## Переменные среды

В `dev` и `preview` SvelteKit будет читать переменные окружения из вашего файла `.env` (или `.env.local`, или `.env.[mode]`, [как определено сборщиком Vite](https://vitejs.dev/guide/env-and-mode.html#env-files)).

В рабочей сборке файлы `.env` _не_ загружаются автоматически. Для этого установите `dotenv` в вашем проекте...

```bash
npm install dotenv
```

...и вызовите его перед запуском созданного приложения:

```diff
-node build
+node -r dotenv/config build
```

### `PORT` и `HOST`

По умолчанию сервер будет принимать соединения по IP-адресу `0.0.0.0`, используя порт 3000. Их можно настроить с помощью переменных окружения `PORT` и `HOST`:

```
HOST=127.0.0.1 PORT=4000 node build
```

### `ORIGIN`, `PROTOCOL_HEADER` и `HOST_HEADER`

HTTP не дает SvelteKit надежного способа узнать URL, который в данный момент запрашивается. Самый простой способ сообщить SvelteKit, где обслуживается приложение, - установить переменную окружения `ORIGIN`:

```
ORIGIN=https://my.site node build
```

В этом случае запрос для пути `/stuff` будет корректно выполняться в `https://my.site/stuff`. В качестве альтернативы вы можете указать заголовки, которые сообщат SvelteKit о протоколе запроса и хосте, на основе которых он сможет построить URL источника:

```
PROTOCOL_HEADER=x-forwarded-proto HOST_HEADER=x-forwarded-host node build
```

> [`x-forwarded-proto`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-Proto) и [`x-forwarded-host`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-Host) - это стандартные заголовки де-факто, которые передают оригинальный протокол и хост, если вы используете обратный прокси (подумайте о балансировщиках нагрузки и CDN). Вы должны устанавливать эти переменные только в том случае, если ваш сервер находится за доверенным обратным прокси-сервером; в противном случае клиенты смогут подделать эти заголовки.

Если `adapter-node` не может правильно определить URL вашего развёртывания, вы можете столкнуться с этой ошибкой при использовании [действий формы](/20-core-concepts/30-form-actions):

> Межсайтовые POST-формы запрещены (Cross-site POST form submissions are forbidden)

### `ADDRESS_HEADER` и `XFF_DEPTH`

Объект [RequestEvent](/50-reference/40-types?id=requestevent), передаваемый хукам и конечным точкам, включает функцию `event.getClientAddress()`, которая возвращает IP-адрес клиента. По умолчанию это подключаемый `remoteAddress`. Если ваш сервер находится за одним или несколькими прокси (например, балансировщик нагрузки), это значение будет содержать IP-адрес самого внутреннего прокси, а не клиента, поэтому нам нужно указать `ADDRESS_HEADER` для чтения адреса:

```
ADDRESS_HEADER=Настоящий-IP-Клиента node build
```

> Заголовки могут быть легко подделаны. Как и в случае с `PROTOCOL_HEADER` и `HOST_HEADER`, вы должны [знать, что вы делаете](https://adam-p.ca/blog/2022/03/x-forwarded-for/), прежде чем устанавливать их.

Если `ADDRESS_HEADER` имеет значение `X-Forwarded-For`, значение заголовка будет содержать список IP-адресов, разделенных запятыми. Переменная окружения `XFF_DEPTH` должна определять, сколько доверенных прокси находится перед вашим сервером. Например, если есть три доверенных прокси, то третий прокси будет пересылать адреса исходного соединения и первых двух прокси:

```
<адрес клиента>, <адрес прокси 1>, <адрес прокси 2>
```

Некоторые руководства советуют читать крайний левый адрес, но это делает вас [уязвимым для подделки](https://adam-p.ca/blog/2022/03/x-forwarded-for/):

```
<поддельный адрес>, <адрес клиента>, <адрес прокси 1>, <адрес прокси 2>
```

Вместо этого мы читаем с _правой стороны_, учитывая количество доверенных прокси. В этом случае мы используем `XFF_DEPTH=3`.

> Если вам нужно читать крайний левый адрес (и вас не волнует подмена) - например, для предоставления услуг геолокации, где важнее чтобы IP-адрес был _реальным_, а не _доверенным_, вы можете сделать это, проверив заголовок `x-forwarded-for` в вашем приложении.

### `BODY_SIZE_LIMIT`

Максимальный размер тела запроса в байтах, включая потоковую передачу. По умолчанию 512 кб. Вы можете отключить эту опцию со значением 0 и реализовать собственную проверку в хуке [`handle`](/30-advanced/20-hooks?id=handle), если вам нужно что-то более продвинутое.

## Параметры

Адаптер может быть сконфигурирован с различными параметрами:

**```svelte.config.js```**
```js
import adapter from '@sveltejs/adapter-node';

export default {
	kit: {
		adapter: adapter({
			// показаны параметры по умолчанию
			out: 'build',
			precompress: false,
			envPrefix: '',
			polyfill: true
		})
	}
};
```

### out

Каталог для сборки сервера. По умолчанию используется `build` — т.е. `node build` будет запускать сервер локально после его создания.

### precompress

Включает предварительное сжатие с помощью gzip и brotli для ресурсов и пререндеренных страниц. По умолчанию имеет значение `false`.

### envPrefix

Если вам нужно изменить имя переменных среды, используемых для настройки развертывания (например, для устранения противоречий с переменными среды, которые вы не контролируете), вы можете указать префикс:

```js
envPrefix: 'MY_CUSTOM_';
```

```sh
MY_CUSTOM_HOST=127.0.0.1 \
MY_CUSTOM_PORT=4000 \
MY_CUSTOM_ORIGIN=https://my.site \
node build
```

### polyfill

Управляет тем, будет ли ваша сборка загружать полифиллы для отсутствующих модулей. По умолчанию установлено значение `true`, и должно быть отключено только при использовании Node 18.11 или выше.

## Пользовательский сервер

Адаптер создает два файла в вашей директории сборки — `index.js` и `handler.js`. Запуск `index.js` — например, `node build`, если вы используете каталог сборки по умолчанию — запустит сервер на настроенном порту.

В качестве альтернативы вы можете импортировать файл `handler.js`, который экспортирует обработчик, подходящий для использования с [Express](https://github.com/expressjs/expressjs.com), [Connect](https://github.com/senchalabs/connect) или [Polka](https://github.com/lukeed/polka) (или даже просто встроенный [`http.createServer`](https://nodejs.org/dist/latest/docs/api/http.html#httpcreateserveroptions-requestlistener)) и настроить свой собственный сервер:

**``` my-server.js```**
```js
import { handler } from './build/handler.js';
import express from 'express';

const app = express();

// добавляет маршрут, который живет отдельно от приложения SvelteKit
app.get('/healthcheck', (req, res) => {
	res.end('ok');
});

// пусть SvelteKit занимается всем остальным, включая обслуживание пререндеренных страниц и статических ресурсов
app.use(handler);

app.listen(3000, () => {
	console.log('прослушивает порт 3000');
});
```

## Устранение неполадок

### Есть ли хук для очистки перед выключением сервера?

В SvelteKit нет ничего встроенного для этого, потому что такой хук очистки сильно зависит от среды выполнения, в которой вы находитесь. Для Node вы можете использовать встроенный `process.on(...)` для реализации колбэка, который выполняется перед завершением работы сервера:

```js
function shutdownGracefully() {
	// все, что вам нужно очистить вручную, помещается сюда
	db.shutdown();
}

process.on('SIGINT', shutdownGracefully);
process.on('SIGTERM', shutdownGracefully);
```
